<?php
/**
 * Created by PhpStorm.
 * User: kit
 * Date: 1/24/2017
 * Time: 2:13 PM
 */

namespace backend\components;

use common\components\BAException;

/**
 * Class SyncManager
 * @package backend\components
 *
 * This is sync manager that is responsible for handling of data (tasks)
 * from device and preparing response
 *
 * @throws BAException
 */
class TasksSyncManager
{
    const WRONG_ROOT_ELEMNT = 'Param ($tasksXML) with WRONG ROOT ELEMENT was sent into synchronization method';

    protected $changeOfTaskHandler;

    public function __construct(ChangeOfTaskHandler $changeOfTaskHandler)
    {
        $this->changeOfTaskHandler = $changeOfTaskHandler;
    }

    public function getTasksFromDevice(\SimpleXMLElement $taskChangesXML)
    {
        $synchronizedTasks = [];
        if ($taskChangesXML->getName() != "changedTasks") {
            throw new BAException(self::WRONG_ROOT_ELEMNT, BAException::WRONG_ROOT_XML_ELEMENT_NAME);
        }
        foreach($taskChangesXML->changeOfTask as $changeOfTaskXML) {
            $globalId = $this->changeOfTaskHandler->handle($changeOfTaskXML);
            if ($globalId != null) {
                $synchronizedTasks[(int)$changeOfTaskXML['localId']] = $globalId;
            }
        }
        return $synchronizedTasks;
    }

    public function sendTasksToDevice()
    {
        // TODO
        return;
    }
}
